var BenImageResizer=function(e){var d={resizeMode:"auto",dataSource:"",dataSourceType:"image",maxWidth:150,maxHeight:200,onTmpImgGenerate:function(g){},success:function(h,g){},debug:false};var c={};$.extend(d,e);var f=function(h,g){if(d.debug==true){if(g){console.log(h,g)}else{console.log(h)}}};var b={getBase4FromImgFile:function(h,i){var g=new FileReader();g.onload=function(k){var j=k.target.result;if(i){i(j)}};g.readAsDataURL(h)},getImgFromDataSource:function(h,i,k){var g=this;var j=new Image();if(i=="img"||i=="image"){j.src=$(h).attr("src");if(k){k(j)}}else{if(i=="base64"){j.src=h;if(k){k(j)}}else{if(i=="canvas"){j.src=h.toDataURL("image/jpeg");if(k){k(j)}}else{if(i=="file"){g.getBase4FromImgFile(function(l){j.src=l;if(k){k(j)}})}}}}},getResizeSizeFromImg:function(j){var m={w:$(j)[0].naturalWidth,h:$(j)[0].naturalHeight};console.log("真实尺寸：");console.log(m);var k={w:0,h:0};if(m.w<=d.maxWidth&&m.h<=d.maxHeight){return m}if(d.resizeMode=="auto"){var i=parseFloat(m.w/m.h);var g={w:0,h:0};var l={w:d.maxWidth,h:parseInt(d.maxWidth/i)};var h={w:parseInt(d.maxHeight*i),h:d.maxHeight};if(l.h<=d.maxHeight){return l}if(h.w<=d.maxWidth){return h}return{w:d.maxWidth,h:d.maxHeight}}if(d.resizeMode=="width"){if(m.w<=d.maxWidth){return m}var l={w:d.maxWidth,h:parseInt(d.maxWidth/i)};return l}if(d.resizeMode=="height"){if(m.h<=d.maxHeight){return m}var h={w:parseInt(d.maxHeight*i),h:d.maxHeight};return h}},drawToCanvas:function(k,j,g,l,h,n){var i=document.createElement("canvas");i.width=j;i.height=g;var o=i.getContext("2d");o.drawImage(k,0,0,l,h,0,0,j,g);var m=i.toDataURL("image/jpeg");if(n){n(m,i)}}};(function(){b.getImgFromDataSource(d.dataSource,d.dataSourceType,function(g){setTimeout(function(){var h=g;d.onTmpImgGenerate(g);var i=b.getResizeSizeFromImg(h);console.log(i);var j={w:$(h)[0].naturalWidth,h:$(h)[0].naturalHeight};b.drawToCanvas(h,i.w,i.h,j.w,j.h,function(l,k){d.success(l,k)})},1000)})})();var a={};return a};var BenUploadUtils=function(l){var e={dom:"",url:"",limitSize:1024,limitFormat:"gif,jpg,jpeg,png,GIF,JPG,PNG",limitFormatCallback:function(m){},limitSizeCallback:function(m){},onUploadCallback:function(m){},onUploadBeforeCallback:function(m){},onUploadSuccessCallback:function(m){},onUploadFailCallback:function(m){},onUploadAlwaysCallback:function(m){}};$.extend(e,l);var h=function(m){return $(m)[0].files[0].size};var c=function(m){return $(m)[0].files[0].type};var g=function(m){return m.split("/")[1]};var f=function(){$(e.dom).on("change",function(n){if(b(this)&&j(this)){var m=new FileReader();var o=$(this)[0].files[0];m.onload=function(q){var p=q.target.result;e.onRenderResizerBefore?e.onRenderResizerBefore(p):"";BenImageResizer({resizeMode:"auto",dataSource:p,dataSourceType:"base64",maxWidth:1200,maxHeight:600,debug:true,onTmpImgGenerate:function(r){},success:function(s,r){e.onRenderResizerAfter?e.onRenderResizerAfter(s):"";a(s)}})};m.readAsDataURL(o)}})};var b=function(n){var m=h(n);if(m>e.limitSize){e.limitSizeCallback({errorCode:500,data:"",msg:"图片不能大于"+e.limitSize+"kb"});return false}else{e.limitSizeCallback({errorCode:200,data:"",msg:"在设置的图片大小范围内"});return true}};var j=function(o){var s=c(o);var m=g(s);var q=e.limitFormat.split(",");var n="";for(var p=0;p<q.length;p++){n+=q[p]+"|"}n=n.substring(0,n.length-1);var r="("+n+")$";if(!new RegExp(r).test(m)){e.limitFormatCallback?e.limitFormatCallback({errorCode:500,data:"",msg:"图片格式不正确，请上传"+e.limitFormat+"的其中一个格式"}):"";return false}else{e.limitFormatCallback?e.limitFormatCallback({errorCode:200,data:"",msg:"在设置的图片格式范围内"}):"";return true}};var d=function(){f()};var i=function(){if($.fn&&$.fn.jquery){return true}return false};var a=function(m){if(i()){$.ajax({url:e.url,type:"POST",dataType:"JSON",data:m||"",beforeSend:function(){e.onUploadBeforeCallback?e.onUploadBeforeCallback():""}}).done(function(n){e.onUploadSuccessCallback?e.onUploadSuccessCallback(n):""}).fail(function(n){e.onUploadFailCallback?e.onUploadFailCallback(n):""}).always(function(){e.onUploadAlwaysCallback?e.onUploadAlwaysCallback():""})}else{$.ajax({url:e.url,type:"POST",dataType:"JSON",data:m||"",beforeSend:function(){e.onUploadBeforeCallback?e.onUploadBeforeCallback():""},success:function(n){e.onUploadSuccessCallback?e.onUploadSuccessCallback(n):""},error:function(n){e.onUploadFailCallback?e.onUploadFailCallback(n):""},complete:function(){e.onUploadAlwaysCallback?e.onUploadAlwaysCallback():""}})}};var k=function(){d()};return{init:k}};